<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Portfoliotracker - Market</title>
        <link href="trade_style.css" rel="stylesheet">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    </head>
</html>

<body>
    <div id="topBar_id">
        <h1>PORTFOLIOTRACKER</h1>
        <span class="material-symbols-outlined" id="topBar_goBack_id">home</span>
    </div>

    <ul>
        <li><a href="/dashboard"><span class="material-symbols-outlined">dashboard</span>Dashboard</a></li>
        <li><a href="/portfolios"><span class="material-symbols-outlined">folder_open</span>Portfolios</a></li>
        <li><a href="/trade" style="color: gray;"><span class="material-symbols-outlined" style="color: gray;">query_stats</span>Market</a></li>
        <li><a href="/accounts"><span class="material-symbols-outlined">account_balance_wallet</span>Accounts</a></li>
        <li><a href="/profile"><span class="material-symbols-outlined">person</span>Profile</a></li>
      </ul>

      <div id="vælgMarked_id">
        <button id="nasDaqButton_id" style="font-weight: bold;" onclick="chooseMarket_nasDaq()">NasDaq</button>
        <button id="CSEButton_id" style="background-color: #252525; color: lightgray;" onclick="chooseMarket_CSE()">CSE</button>
      </div>
      <br>
      <div id="stockBox_id">
        <input placeholder="Search stock..." autofocus id="searchStocks_input_id">
        <div id="boi" style="color: white"></div>
      </div>
      
      <div id="ViewBuystockBox_id">
        <div id="viewStock_id">
          <span id="aktieNavn_id"></span>
          <div id="myChart"></div>
        </div>
        <div id="StockPurchaseInfo_id">
          <input id="NumberOfStocks_id" type="number" max="99999" min="1" placeholder="1">
          <select name="Vælg portefølje" id="vælgPortefølje_id">
            <option value="">Vælg portefølje</option>
            <option value="">Tech</option>
            <option value="">Food</option>
            <option value="">Defence</option>
          </select>
          <select name="vælg konto" id="vælgKonto_id">
            <option value="">Vælg konto</option>
            <option value="">Gamerkonto</option>
            <option value="">Børnepenge</option>
            <option value="">Madpenge</option>
          </select>
          <button id="BuyStockButton_id">Purchase</button>
        </div>
      </div>

</body>


<script>
  
  
</script>

<script>

  let stockName = "";


for (let i = 0; i < NasDaqstocks.length; i++) {
    const para = document.createElement("button");
    const node = document.createTextNode(NasDaqstocks[i]);

    para.setAttribute("data-ticker", NasDaqstocksTicker[i]);
    para.type = "button";

    para.appendChild(node);
    
    para.addEventListener("click", function(event) {
        let ticker = event.currentTarget.dataset.ticker;
        stockName = event.currentTarget.textContent;
        
        document.querySelectorAll('button').forEach(el => {
          el.classList.remove('active'); // Reset all
});

event.currentTarget.classList.add('active'); // Set current one to blue

        
        console.log("Ticker clicked:", ticker); // For debugging
        retrieveStockTicker(ticker);
    });

    const element = document.getElementById("boi");
    element.appendChild(para);
}







// Search stocks //
let userInput_SearchStocks = "";

function searchStocks(event) {
  userInput_SearchStocks = document.getElementById("searchStocks_input_id").value.toLowerCase();

  const buttons = document.querySelectorAll("#boi button");

  buttons.forEach(button => {
    const text = button.textContent.toLowerCase();
    if (text.includes(userInput_SearchStocks)) {
      button.style.display = "inline-block"; // or "block", depending on your layout
    } else {
      button.style.display = "none";
    }
  });
}
document.getElementById("searchStocks_input_id").addEventListener("keyup", searchStocks);






// -------------------------------------------------------------------------------------//

// RETRIEVE STOCK DATA //

// -------------------------------------------------------------------------------------//


let boi = [];

function retrieveStockTicker(ticker) {
    let key = ticker; // Denne variabel bestemmer hvilket data der hentes
    console.log(ticker);

    fetch(`/api/data?key=${key}`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
            console.log(data.error);
        } else {
            console.log(data);  // This will log the fetched stock data (prices)
            boi = data;
            boi = boi.map(boi => Math.round(boi * 100)/100);
            displayStock();
        }
      })
      .catch(error => {
        console.error('Error fetching data:', error);
      });

      // Viser aktie navn når der trykkes på aktie //
      document.getElementById("aktieNavn_id").innerHTML = stockName;
}


let dates = [];

function get14days(){
  
const today = new Date();

for (let i = 0; i < 14; i++) {
  const date = new Date();
  date.setDate(today.getDate() - i);

  const day = date.getDay(); // 0 = Sunday, 6 = Saturday
  if (day !== 0 && day !== 6) {
    const formatted = date.toISOString().split('T')[0];
    dates.push(formatted);
  }
}
dates.reverse(); // optional: to have oldest to newest
console.log(dates);

}
get14days();


function displayStock(){


  document.getElementById("myChart").innerHTML = "";

  const xValues = dates;
const options = {
      chart: {
        type: 'line',
        height: 350,
        fontFamily: 'normalSkrift'
      },
      colors: ['blue'], // Graflinje farve
      
      series: [{
        name: 'Aktiekurs',
        data: boi
      }],
      xaxis: {
        categories: xValues,
        labels: {
          style: {
            colors: '#fff' // Tekstfarve på x-aksen
          }
        },
        title: {
          text: 'Ugedage',
          style: {
            color: 'lightgray'
          }
        }
      },
      yaxis: {
        labels: {
          style: {
            colors: 'lightgray' // Tekstfarve på y-aksen
          }
        },
        title: {
          text: 'Kurs (DKK)',
          style: {
            color: 'lightgray'
          }
        }
      },
      
      stroke: {
        curve: 'smooth'
      },


      tooltip: {
        theme: 'dark',
        style: {
          fontSize: '14px',
          fontFamily: 'normalSkrift',
          backgroundColor: 'black'
        },
        marker: {
          show: true,
          fillColors: ['blue']
        },
  y: {
    formatter: function (value) {
      return value + " DKK";
    }
  }
},

grid: {
  show: true, // sæt til false hvis du vil skjule alle gitterlinjer
  borderColor: 'gray', // farven på linjerne
  strokeDashArray: 4, // gør dem stiplede (0 = fuldt optrukket)
  xaxis: {
    lines: {
      show: false // fjerner vertikale linjer
    }
  },
  yaxis: {
    lines: {
      show: true // viser horisontale linjer
    }
  }
}

    };

    const chart = new ApexCharts(document.querySelector("#myChart"), options);
    chart.render();

};
</script>